CÃ i Ä‘áº·t Kafka trÃªn Linux (Ubuntu/CentOS)
A. CÃ i Ä‘áº·t Java

Kafka cáº§n Java 11 trá»Ÿ lÃªn:
sudo apt update
sudo apt install openjdk-11-jdk -y
java -version

B. Táº£i vÃ  giáº£i nÃ©n Kafka
cd /opt
sudo wget https://downloads.apache.org/kafka/3.7.0/kafka_2.13-3.7.0.tgz
sudo tar -xvzf kafka_2.13-3.7.0.tgz
sudo mv kafka_2.13-3.7.0 kafka
cd kafka

ğŸ—‚ï¸ 3. Cáº¥u hÃ¬nh Kafka cÆ¡ báº£n

File cáº¥u hÃ¬nh chÃ­nh:
/opt/kafka/config/server.properties

âœ… Máº«u cáº¥u hÃ¬nh Production cÆ¡ báº£n:
# ID cá»§a broker
broker.id=1

# Listener
listeners=PLAINTEXT://0.0.0.0:9092
advertised.listeners=PLAINTEXT://kafka01.internal.local:9092

# Log lÆ°u message
log.dirs=/var/lib/kafka/data

# Zookeeper (náº¿u khÃ´ng dÃ¹ng KRaft mode)
zookeeper.connect=zookeeper01:2181,zookeeper02:2181,zookeeper03:2181

# Sá»‘ partition máº·c Ä‘á»‹nh
num.partitions=3

# Sao lÆ°u dá»¯ liá»‡u
default.replication.factor=3
min.insync.replicas=2

# Giá»›i háº¡n dung lÆ°á»£ng / thá»i gian lÆ°u
log.retention.hours=168
log.segment.bytes=1073741824

ğŸ§© 4. Khá»Ÿi Ä‘á»™ng dá»‹ch vá»¥ Kafka
(A) Start ZooKeeper (náº¿u dÃ¹ng)
bin/zookeeper-server-start.sh config/zookeeper.properties

(B) Start Kafka
bin/kafka-server-start.sh config/server.properties

(C) Kiá»ƒm tra tiáº¿n trÃ¬nh:
ps aux | grep kafka
netstat -tulnp | grep 9092

ğŸ§ª 5. Kiá»ƒm tra hoáº¡t Ä‘á»™ng cÆ¡ báº£n
Táº¡o topic
bin/kafka-topics.sh --create --topic demo --bootstrap-server localhost:9092 --partitions 3 --replication-factor 1

Liá»‡t kÃª topic
bin/kafka-topics.sh --list --bootstrap-server localhost:9092

Gá»­i message (Producer)
bin/kafka-console-producer.sh --topic demo --bootstrap-server localhost:9092

Nháº­n message (Consumer)
bin/kafka-console-consumer.sh --topic demo --bootstrap-server localhost:9092 --from-beginning

ğŸ” 6. Cáº¥u hÃ¬nh báº£o máº­t (Security)
(A) Báº­t SSL encryption

Sinh chá»©ng chá»‰:

keytool -genkey -keystore kafka.server.keystore.jks -validity 365 -storepass changeit -keypass changeit -dname "CN=kafka01"


Chá»‰nh server.properties:

listeners=SSL://:9093
ssl.keystore.location=/etc/kafka/kafka.server.keystore.jks
ssl.keystore.password=changeit
security.inter.broker.protocol=SSL

(B) Báº­t xÃ¡c thá»±c SASL/PLAIN
listeners=SASL_PLAINTEXT://:9094
sasl.enabled.mechanisms=PLAIN
sasl.mechanism.inter.broker.protocol=PLAIN


Táº¡o file ngÆ°á»i dÃ¹ng:

echo 'user_admin=admin-password' > /opt/kafka/config/kafka_server_jaas.conf

ğŸ“ˆ 7. Monitoring Kafka
Prometheus Exporter:

CÃ i kafka_exporter:

wget https://github.com/danielqsj/kafka_exporter/releases/download/v1.7.0/kafka_exporter-1.7.0.linux-amd64.tar.gz
tar -xzf kafka_exporter-1.7.0.linux-amd64.tar.gz
./kafka_exporter --kafka.server=kafka01:9092


Sau Ä‘Ã³ cáº¥u hÃ¬nh Grafana â†’ add data source Prometheus â†’ import dashboard â€œKafka Overviewâ€.

ğŸ’¾ 8. Backup & Restore Kafka data
A. Backup topic config:
bin/kafka-topics.sh --describe --topic mytopic --bootstrap-server localhost:9092 > topic_config.txt

B. Backup log data:

Dá»¯ liá»‡u lÆ°u táº¡i /var/lib/kafka/data

Snapshot báº±ng rsync / LVM snapshot / filesystem backup

C. Restore:

Stop broker

Restore thÆ° má»¥c data

Start láº¡i broker

ğŸ§  9. Troubleshooting Kafka
Váº¥n Ä‘á»	NguyÃªn nhÃ¢n	CÃ¡ch xá»­ lÃ½
Broker khÃ´ng start Ä‘Æ°á»£c	Port 9092 bá»‹ chiáº¿m, file lock, hoáº·c lá»—i ZooKeeper	`netstat -tulnp
Producer Timeout	KhÃ´ng káº¿t ná»‘i Ä‘Æ°á»£c tá»›i advertised.listeners	Kiá»ƒm tra DNS hoáº·c hostname mapping
Consumer lag tÄƒng cao	Consumer cháº­m hoáº·c dead	kafka-consumer-groups.sh --describe Ä‘á»ƒ xem lag
Disk full	retention time quÃ¡ lÃ¢u	Giáº£m log.retention.hours hoáº·c xÃ³a topic cÅ©
Replication under-replicated	Broker khÃ¡c bá»‹ down	kafka-topics.sh --describe â†’ restart broker máº¥t káº¿t ná»‘i
Controller election fail	ZooKeeper hoáº·c KRaft lá»—i	Kiá»ƒm tra controller.log hoáº·c zookeeper.log
High GC pause time	JVM heap khÃ´ng Ä‘á»§	Äiá»u chá»‰nh KAFKA_HEAP_OPTS="-Xmx4G -Xms4G"
Unclean leader election	Máº¥t dá»¯ liá»‡u khi leader cháº¿t	Táº¯t unclean.leader.election.enable vÃ  tÄƒng replication
ğŸ”„ 10. Scale & HA Kafka
Scale out thÃªm broker:

Copy config tá»« broker cÅ©

Äáº·t broker.id má»›i

Start broker

Kafka tá»± Ä‘á»™ng cÃ¢n báº±ng partition (hoáº·c dÃ¹ng kafka-reassign-partitions.sh)

Failover test:

Táº¯t 1 broker â†’ consumer váº«n hoáº¡t Ä‘á»™ng bÃ¬nh thÆ°á»ng náº¿u replication Ä‘á»§

ğŸ§© 11. Kafka trong Production

âœ… Checklist cho System Engineer:

 3â€“5 broker HA

 Replication â‰¥ 3

 Min in-sync replicas = 2

 Security: SSL + SASL

 Monitoring: Prometheus + Grafana

 Backup: log + metadata

 Alert: consumer lag, disk usage, offline partitions

 Integration: Kafka Connect, Schema Registry
